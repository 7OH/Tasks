
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	ОчиститьСвязанныеТЧ();
	СформироватьСписокЗадач();
КонецПроцедуры

Процедура СформироватьСписокЗадач() Экспорт
	пСписокЗадач = "";
	Для каждого СтрокаТЧЗадачи из ТЧЗадачи цикл
		пСписокЗадач = пСписокЗадач + "#"+СтрокаТЧЗадачи.Задача.Код + ", ";		
	Конеццикла;
	пСписокЗадач = Лев(пСписокЗадач, СтрДлина(пСписокЗадач) - 2);
	СписокЗадач = пСписокЗадач;
КонецПроцедуры 

Процедура ОчиститьСвязанныеТЧ() Экспорт
	
	МассивЗадач = ТЧЗадачи.ВыгрузитьКолонку("Задача");
	
	МассивОбрабатываемыхТЧ = Новый Массив();
	МассивОбрабатываемыхТЧ.Добавить("ИсторияХранилища");
	МассивОбрабатываемыхТЧ.Добавить("ИзмененныеОбъекты");
	
	Для каждого ИмяТЧ из МассивОбрабатываемыхТЧ цикл
		СтрокиКУдалению = Новый Массив();
		
		Для каждого СтрокаТЧ из ЭтотОбъект[ИмяТЧ] цикл
			пЗадача = СтрокаТЧ.Задача;
			Если МассивЗадач.Найти(пЗадача) = Неопределено Тогда
				СтрокиКУдалению.Добавить(СтрокаТЧ);
			Конецесли;
		Конеццикла;	
		
		Для каждого СтрокаКУдалению из СтрокиКУдалению цикл
			ЭтотОбъект[ИмяТЧ].Удалить(СтрокаКУдалению);		
		Конеццикла;
	Конеццикла;
КонецПроцедуры 
